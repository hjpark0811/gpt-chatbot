require("dotenv").config();
const express = require("express");
const axios = require("axios");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static("public"));

// êµì‚¬ ì´ë¦„ â†’ ìœ„ì¹˜ ë§¤í•‘
const teacherLocationMap = {
  "ê¹€í˜„ì„":"êµìž¥ | êµìž¥ì‹¤ | 1ì¸µ",
  "ì˜¤ê²½ìˆœ":"êµê° | êµê°ì‹¤ | 2ì¸µ",
  "ìž¥ì„ í¬":"ìˆ˜ì„êµì‚¬ì‹¤ | ì •ë³´ì»´í“¨í„° | 3ì¸µ",
  "í•œì„ í¬":"êµë¬´ê¸°íšë¶€ | êµ­ì–´ | 2ì¸µ",
  "ê¶Œìˆœì•„":"êµë¬´ê¸°íšë¶€ | ì¼ë³¸ì–´ | 2ì¸µ",
  "ìœ ë¯¼ì§€":"êµë¬´ê¸°íšë¶€ | í™”í•™ | 2ì¸µ",
  "ìµœë¯¼ê²½":"êµë¬´ê¸°íšë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "í•œê°€ì—°":"êµë¬´ê¸°íšë¶€ | ì˜ì–´ | 2ì¸µ",
  "ì´ë´‰í¬":"êµìœ¡ì—°êµ¬ë¶€ | ê¸°ìˆ  | 2ì¸µ",
  "ì†ê¸°ë¯¼":"êµìœ¡ì—°êµ¬ë¶€ | ì§€ë¦¬ | 2ì¸µ",
  "ê¹€ê·¼ì›":"êµìœ¡ì—°êµ¬ë¶€ | ì •ë³´ì»´í“¨í„° | 2ì¸µ",
  "ì¡°ì¼í™˜":"êµìœ¡ì—°êµ¬ë¶€ | ì§€ë¦¬ | 2ì¸µ",
  "ìœ ì£¼ì—°":"ë¯¸ëž˜êµìœ¡ë¶€ | ë„ë•ìœ¤ë¦¬ | 3ì¸µ",
  "ì •ê²½":"ë¯¸ëž˜êµìœ¡ë¶€ | êµ­ì–´ | 3ì¸µ",
  "ì´ì˜ë‚¨":"ë¯¸ëž˜êµìœ¡ë¶€ | ì§€ë¦¬ | 3ì¸µ",
  "ì´ì¢…ë¯¸":"ë¯¸ëž˜êµìœ¡ë¶€ | ë„ì„œì‹¤ | ì‚¬ì„œ | 2ì¸µ",
  "ì„œìœ íƒœ":"êµìœ¡ê³¼ì •ë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "ì´ë¯¸ìˆ™":"êµìœ¡ê³¼ì •ë¶€ | êµ­ì–´ | 2ì¸µ",
  "ìµœëª…ì£¼":"êµìœ¡ê³¼ì •ë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "ì„œí˜„êµ°":"í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ì²´ìœ¡ | 4ì¸µ",
  "ì´ì¼ì˜":"í•™ìƒìžì¹˜ì•ˆì „ë¶€ | êµ­ì–´ | 4ì¸µ",
  "ê¹€ì†Œë¼":"í•™ìƒìžì¹˜ì•ˆì „ë¶€ | êµ­ì–´ | 4ì¸µ",
  "ë°±ìŠ¹ì˜¥":"í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ìˆ˜í•™ | 4ì¸µ",
  "ìž¥íƒí™":"í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ì²´ìœ¡ | 4ì¸µ",
  "ì—¼ì§€ì˜":"ì§„ë¡œìƒë‹´ë¶€ | ì§„ë¡œì „ë‹´ | 4ì¸µ",
  "ìž¥ìš©ë‚¨":"ì§„ë¡œìƒë‹´ë¶€ | ë¯¸ìˆ  | 4ì¸µ",
  "ì˜¤ì±„í˜„":"ì§„ë¡œìƒë‹´ë¶€ | ì „ë¬¸ìƒë‹´ | 4ì¸µ",
  "ì‹ ì€ê²½":"êµìœ¡ì •ë³´ë¶€ | ìˆ˜í•™ | 3ì¸µ",
  "ì˜¤ì„¸ì •":"êµìœ¡ì •ë³´ë¶€ | ì •ë³´ì»´í“¨í„° | 3ì¸µ",
  "ê¹€í˜":"ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ì²´ìœ¡ | 3ì¸µ",
  "ë°•ì¢…ë°°":"ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ì²´ìœ¡ | 3ì¸µ",
  "ê¹€íš¨ì˜":"ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ë³´ê±´ì‹¤ | ë³´ê±´ | 3ì¸µ",
  "ì „ì„ ì˜":"ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ê¸‰ì‹ì‹¤ | ì˜ì–‘ | 1ì¸µ",
  "ì´ê²½ì¤€":"ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€ | í™”í•™ | 2ì¸µ",
  "ê¹€ì •í˜„":"ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€ | ë¬¼ë¦¬ | 2ì¸µ",
  "ì„±í™ì—°":"1í•™ë…„ë¶€ | ë¶€ìž¥ | ì§€êµ¬ê³¼í•™ | 1ì¸µ",
  "ìµœì‹œí™©":"1í•™ë…„ë¶€ | 1-1 | ì§€êµ¬ê³¼í•™ | 1ì¸µ",
  "ìœ¤ì„ í¬":"1í•™ë…„ë¶€ | 1-2 | ë„ë•ìœ¤ë¦¬ | 1ì¸µ",
  "ì •í•˜ë¦¼":"1í•™ë…„ë¶€ | 1-3 | ì˜ì–´ | 1ì¸µ",
  "ë°•ê²½ì§„":"1í•™ë…„ë¶€ | 1-4 | ì—­ì‚¬ | 1ì¸µ",
  "ì„œê²½í™˜":"1í•™ë…„ë¶€ | 1-5 | ì¼ë°˜ì‚¬íšŒ | 1ì¸µ",
  "ê³ í•œì†”":"1í•™ë…„ë¶€ | 1-6 | ì˜ì–´ | 1ì¸µ",
  "ê¹€ì§€í˜„":"1í•™ë…„ë¶€ | 1-7 | ì—­ì‚¬ | 1ì¸µ",
  "ì§„í˜„ì¶©":"1í•™ë…„ë¶€ | 1-8 | ìŒì•… | 1ì¸µ",
  "ê¹€ì˜í˜„":"1í•™ë…„ë¶€ | 1-9 | ì˜ì–´ | 1ì¸µ",
  "ë°•ì°¬í•´":"1í•™ë…„ë¶€ | 1-10 | êµ­ì–´ | 1ì¸µ",
  "ì´ê²½ì§„":"1í•™ë…„ë¶€ | 1-11 | ìˆ˜í•™ | 1ì¸µ",
  "ì •í™ëª…":"2í•™ë…„ë¶€ | ë¶€ìž¥ | ìˆ˜í•™ | 4ì¸µ",
  "ì´ìž¬ì² ":"2í•™ë…„ë¶€ | 2-1 | ì˜ì–´ | 4ì¸µ",
  "í˜„ì§€ì•„":"2í•™ë…„ë¶€ | 2-2 | ì—­ì‚¬ | 4ì¸µ",
  "ë°©ë¯¼ì˜":"2í•™ë…„ë¶€ | 2-3 | ì¼ë°˜ì‚¬íšŒ | 4ì¸µ",
  "ê¹€ì •ë¯¼":"2í•™ë…„ë¶€ | 2-4 | ìŒì•… | 4ì¸µ",
  "ìœ¤íš¨ì •":"2í•™ë…„ë¶€ | 2-5 | ì¼ë³¸ì–´ | 4ì¸µ",
  "ì´ìš©ìˆœ":"2í•™ë…„ë¶€ | 2-6 | ì¤‘êµ­ì–´ | 4ì¸µ",
  "ì´ì†Œë¯¼":"2í•™ë…„ë¶€ | 2-7 | ë¬¼ë¦¬ | 4ì¸µ",
  "ê¹€ì€ì§€":"2í•™ë…„ë¶€ | 2-8 | ì˜ì–´ | 4ì¸µ",
  "ë°•ë¯¸í™":"2í•™ë…„ë¶€ | 2-9 | ìƒëª…ê³¼í•™ | 4ì¸µ",
  "ìµœìˆ˜ë¯¼":"2í•™ë…„ë¶€ | 2-10 | êµ­ì–´ | 4ì¸µ",
  "ë¥˜ë¯¼ìˆ˜":"2í•™ë…„ë¶€ | 2-11 | ì²´ìœ¡ | 4ì¸µ",
  "í™ì§€í˜„":"3í•™ë…„ë¶€ | ë¶€ìž¥ | ì¼ë°˜ì‚¬íšŒ | 5ì¸µ",
  "í•œìš°ë¦¬":"3í•™ë…„ë¶€ | 3-1 | ë¯¸ìˆ  | 5ì¸µ",
  "ë°•ì •ì›":"3í•™ë…„ë¶€ | 3-2 | ì¼ë°˜ì‚¬íšŒ | 5ì¸µ",
  "í•œí˜œì¤‘":"3í•™ë…„ë¶€ | 3-3 | êµ­ì–´ | 5ì¸µ",
  "ê¹€í˜„ì§„":"3í•™ë…„ë¶€ | 3-4 | ìˆ˜í•™ | 5ì¸µ",
  "ìµœì›íƒœ":"3í•™ë…„ë¶€ | 3-5 | ë„ë•ìœ¤ë¦¬ | 5ì¸µ",
  "ìµœì§„ì² ":"3í•™ë…„ë¶€ | 3-6 | í•œë¬¸ | 5ì¸µ",
  "ì¡°í˜„ì„ ":"3í•™ë…„ë¶€ | 3-7 | ì˜ì–´ | 5ì¸µ",
  "ê°•ì§€ì›":"3í•™ë…„ë¶€ | 3-8 | ì˜ì–´ | 5ì¸µ",
  "ì´ì†”í¬":"3í•™ë…„ë¶€ | 3-9 | ê°€ì • | 5ì¸µ",
  "ì´ë¯¸ë ¹":"3í•™ë…„ë¶€ | 3-10 | ìˆ˜í•™ | 5ì¸µ",
  "ìœ ì§€ìˆ˜":"3í•™ë…„ë¶€ | 3-11 | ìƒëª…ê³¼í•™ | 5ì¸µ",
  "ì†¡ë³´ë¯¸":"íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ê¹€ë¯¸ì •":"íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ê¹€ë‚˜ì—°":"íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ë°•ì§€ì›":"íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ë¥˜ì€í¬":"íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ"
};

// ê³¼ëª©ëª… â†’ ë‹´ë‹¹ êµì‚¬ ë§¤í•‘
const subjectTeacherMap = {
  "í™”ë²•ê³¼ ìž‘ë¬¸": ["í•œí˜œì¤‘", "í•œì„ í¬"],
  "ì–¸ì–´ì™€ ë§¤ì²´": ["í•œì„ í¬"],
  "ë¬¸í•™": ["ìµœìˆ˜ë¯¼", "ì •ê²½", "ì´ì¼ì˜"],
  "ê³ ì „ ì½ê¸°": ["ê¹€ì†Œë¼", "ì •ê²½"],
  "ìˆ˜í•™": ["ì‹ ì€ê²½", "ì„œìœ íƒœ", "ì •í™ëª…"],
  "ë¯¸ì ë¶„": ["ì´ë¯¸ë ¹"],
  "í™•ë¥ ê³¼ í†µê³„": ["ìµœë¯¼ê²½", "ê¹€í˜„ì§„", "ì´ë¯¸ë ¹"],
  "ê¸°í•˜": ["ìµœë¯¼ê²½", "ì„œìœ íƒœ"],
  "ê²½ì œ ìˆ˜í•™": ["ë°±ìŠ¹ì˜¥"],
  "ì˜ì–´ íšŒí™”": ["ì¡°í˜„ì„ ", "ê°•ì§€ì›"],
  "ì˜ì–´": ["í•œê°€ì—°", "ì •í•˜ë¦¼", "ì´ìž¬ì² ", "ê¹€ì€ì§€"],
  "ì˜ì–´ ë…í•´ì™€ ìž‘ë¬¸": ["ì¡°í˜„ì„ ", "í•œê°€ì—°", "ê°•ì§€ì›"],
  "ì§„ë¡œ ì˜ì–´": ["ì¡°í˜„ì„ ", "ê°•ì§€ì›"],
  "í•œêµ­ì§€ë¦¬": ["ì´ì˜ë‚¨"],
  "ì„¸ê³„ì§€ë¦¬": ["ì¡°ì¼í™˜"],
  "ì„¸ê³„ì‚¬": ["í˜„ì§€ì•„"],
  "ê²½ì œ": ["í™ì§€í˜„"],
  "ì •ì¹˜ì™€ ë²•": ["ë°©ë¯¼ì˜"],
  "ì‚¬íšŒë¬¸í™”": ["ë°©ë¯¼ì˜", "ë°•ì •ì›"],
  "ìƒí™œê³¼ ìœ¤ë¦¬": ["ìœ¤ì„ í¬", "ìµœì›íƒœ"],
  "ìœ¤ë¦¬ì™€ ì‚¬ìƒ": ["ìœ ì£¼ì—°"],
  "ì—¬í–‰ì§€ë¦¬": ["ì´ì˜ë‚¨"],
  "ì‚¬íšŒë¬¸ì œ íƒêµ¬": ["ì¡°ì¼í™˜", "ì†ê¸°ë¯¼", "ë°•ì •ì›", "ì„œê²½í™˜"],
  "ê³ ì „ê³¼ ìœ¤ë¦¬": ["ìœ ì£¼ì—°", "ìµœì›íƒœ"],
  "ì‚¬íšŒ íƒêµ¬ ë°©ë²•": ["ë°•ì •ì›"],
  "ë¬¼ë¦¬í•™1": ["ì´ì†Œë¯¼"],
  "ë¬¼ë¦¬í•™2": ["ê¹€ì •í˜„"],
  "í™”í•™1": ["ìœ ë¯¼ì§€"],
  "í™”í•™2": ["ì´ê²½ì¤€"],
  "ìƒëª…ê³¼í•™1": ["ë°•ë¯¸í™"],
  "ìƒëª…ê³¼í•™2": ["ìœ ì§€ìˆ˜"],
  "ì§€êµ¬ê³¼í•™1": ["ìµœì‹œí™©"],
  "ì§€êµ¬ê³¼í•™2": ["ì„±í™ì—°"],
  "ìƒí™œê³¼ ê³¼í•™": ["ê¹€ì •í˜„", "ìœ ë¯¼ì§€", "ìœ ì§€ìˆ˜"],
  "ìœµí•©ê³¼í•™": ["ì´ê²½ì¤€"],
  "ìš´ë™ê³¼ ê±´ê°•": ["ìž¥íƒí™", "ë¥˜ë¯¼ìˆ˜", "ì„œí˜„êµ°"],
  "ìŠ¤í¬ì¸  ìƒí™œ": ["ê¹€í˜", "ì„œí˜„êµ°"],
  "ì²´ìœ¡ ì „ê³µ ì‹¤ê¸° ê¸°ì´ˆ": ["ë°•ì¢…ë°°"],
  "ìŒì•… ì—°ì£¼": ["ê¹€ì •ë¯¼"],
  "ìŒì•… ê°ìƒê³¼ ë¹„í‰": ["ê¹€ì •ë¯¼", "ì§„í˜„ì¶©"],
  "ë¯¸ìˆ  ì°½ìž‘": ["í•œìš°ë¦¬"],
  "ë¯¸ìˆ  ê°ìƒê³¼ ë¹„í‰": ["ìž¥ìš©ë‚¨", "í•œìš°ë¦¬"],
  "ì •ë³´": ["ê¹€ê·¼ì›", "ì˜¤ì„¸ì •"],
  "ê³µí•™ ì¼ë°˜": ["ì´ë´‰í¬"],
  "ì¼ë³¸ì–´": ["ê¶Œìˆœì•„", "ìœ¤íš¨ì •"],
  "ì¤‘êµ­ì–´": ["ì´ìš©ìˆœ"],
  "í•œë¬¸": ["ìµœì§„ì² "],
  "êµìœ¡í•™": ["ìµœì§„ì² "],
  "ì‹¤ìš© ê²½ì œ": ["í™ì§€í˜„"],
  "ì¤‘êµ­ì–´ íšŒí™”": ["ì´ìš©ìˆœ"],
  "ì¼ë³¸ì–´ íšŒí™”": ["ê¶Œìˆœì•„", "ìœ¤íš¨ì •"],
  "ì‹í’ˆê³¼ ì˜ì–‘": ["ì´ì†”í¬"],
  "ì¸ê³µì§€ëŠ¥ ê¸°ì´ˆ": ["ìž¥ì„ í¬", "ê¹€ê·¼ì›"],
  "ìƒí™œê³¼ í•œë¬¸": ["ìµœì§„ì² "],
  "ê³µí†µêµ­ì–´": ["ê¹€ì†Œë¼", "ë°•ì°¬í•´", "ì´ë¯¸ìˆ™"],
  "ê³µí†µìˆ˜í•™": ["ìµœëª…ì£¼", "ì´ê²½ì§„", "ë°±ìŠ¹ì˜¥"],
  "ê³µí†µì˜ì–´": ["ê³ í•œì†”", "ì •í•˜ë¦¼", "ê¹€ì˜í˜„"],
  "í•œêµ­ì‚¬": ["ë°•ê²½ì§„", "ê¹€ì§€í˜„", "í˜„ì§€ì•„"],
  "í†µí•©ì‚¬íšŒ": ["ì†ê¸°ë¯¼", "ì„œê²½í™˜", "ìœ¤ì„ í¬"],
  "í†µí•©ê³¼í•™": ["ë°•ë¯¸í™", "ì„±í™ì—°", "ê¹€ì •í˜„", "ì´ì†Œë¯¼", "ìµœì‹œí™©"],
  "ê³¼í•™íƒêµ¬ì‹¤í—˜": ["ë°•ë¯¸í™", "ì„±í™ì—°", "ê¹€ì •í˜„", "ì´ì†Œë¯¼", "ìµœì‹œí™©"],
  "ì²´ìœ¡": ["ìž¥íƒí™", "ë°•ì¢…ë°°", "ë¥˜ë¯¼ìˆ˜"],
  "ìŒì•…": ["ì§„í˜„ì¶©"],
  "ë¯¸ìˆ ": ["ìž¥ìš©ë‚¨"],
  "ê¸°ìˆ ": ["ì´ë´‰í¬"],
  "ë¬¼ë¦¬í•™": ["ê¹€ì •í˜„", "ì´ì†Œë¯¼"],
  "ê°€ì •": ["ì´ì†”í¬"],
  "í™”í•™": ["ì´ê²½ì¤€", "ìœ ë¯¼ì§€"]
};

// âœ‰ï¸ ì±— ì—”ë“œí¬ì¸íŠ¸
app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message.trim();

  // 1. êµì‚¬ ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ ê²€ì‚¬
  for (const teacher of Object.keys(teacherLocationMap)) {
    if (userMessage.includes(teacher)) {
      const location = teacherLocationMap[teacher];
      return res.json({ reply: `${teacher} ì„ ìƒë‹˜ì˜ êµë¬´ì‹¤ ìœ„ì¹˜ëŠ” ${location}ìž…ë‹ˆë‹¤.` });
    }
  }

  // 2. ê³¼ëª©ëª…ì´ í¬í•¨ë˜ì–´ ìžˆëŠ”ì§€ ê²€ì‚¬
  for (const subject of Object.keys(subjectTeacherMap)) {
    if (userMessage.includes(subject)) {
      const teachers = subjectTeacherMap[subject].join(", ");
      return res.json({ reply: `â€œ${subject}â€ ê³¼ëª©ì˜ ë‹´ë‹¹ ì„ ìƒë‹˜ì€ ${teachers} ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.` });
    }
  }

  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: userMessage }],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        },
      }
    );

    const reply = response.data.choices[0].message.content;

    // âœ… ì½˜ì†”ì— ì´ìš© ê¸°ë¡ ë¡œê·¸ ì¶œë ¥
    console.log("ðŸ—¨ï¸ ì´ìš© ê¸°ë¡ ==================");
    console.log("ðŸ“… ì‹œê°„:", new Date().toLocaleString());
    console.log("ðŸ™‹ ì‚¬ìš©ìž:", userMessage);
    console.log("ðŸ¤– ì±—ë´‡ ì‘ë‹µ:", reply);
    console.log("================================\n");

    res.json({ reply });
  } catch (error) {
    console.error("âŒ GPT í˜¸ì¶œ ì˜¤ë¥˜:", error.response?.data || error.message);
    res.status(500).json({ error: "GPT ì‘ë‹µ ì‹¤íŒ¨" });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
});
