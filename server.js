require("dotenv").config();
const express = require("express");
const axios = require("axios");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static("public"));

// 교사 이름 → 위치 매핑
const teacherLocationMap = {
  "김현석":"교장 | 교장실 | 1층",
  "오경순":"교감 | 교감실 | 2층",
  "장선희":"수석교사실 | 정보컴퓨터 | 3층",
  "한선희":"교무기획부 | 국어 | 2층",
  "권순아":"교무기획부 | 일본어 | 2층",
  "유민지":"교무기획부 | 화학 | 2층",
  "최민경":"교무기획부 | 수학 | 2층",
  "한가연":"교무기획부 | 영어 | 2층",
  "이봉희":"교육연구부 | 기술 | 2층",
  "손기민":"교육연구부 | 지리 | 2층",
  "김근원":"교육연구부 | 정보컴퓨터 | 2층",
  "조일환":"교육연구부 | 지리 | 2층",
  "유주연":"미래교육부 | 도덕윤리 | 3층",
  "정경":"미래교육부 | 국어 | 3층",
  "이의남":"미래교육부 | 지리 | 3층",
  "이종미":"미래교육부 | 도서실 | 사서 | 2층",
  "서유태":"교육과정부 | 수학 | 2층",
  "이미숙":"교육과정부 | 국어 | 2층",
  "최명주":"교육과정부 | 수학 | 2층",
  "서현군":"학생자치안전부 | 체육 | 4층",
  "이일영":"학생자치안전부 | 국어 | 4층",
  "김소라":"학생자치안전부 | 국어 | 4층",
  "백승옥":"학생자치안전부 | 수학 | 4층",
  "장탁홍":"학생자치안전부 | 체육 | 4층",
  "염지영":"진로상담부 | 진로전담 | 4층",
  "장용남":"진로상담부 | 미술 | 4층",
  "오채현":"진로상담부 | 전문상담 | 4층",
  "신은경":"교육정보부 | 수학 | 3층",
  "오세정":"교육정보부 | 정보컴퓨터 | 3층",
  "김혁":"문화예술체육교육부 | 체육 | 3층",
  "박종배":"문화예술체육교육부 | 체육 | 3층",
  "김효영":"문화예술체육교육부 | 보건실 | 보건 | 3층",
  "전선영":"문화예술체육교육부 | 급식실 | 영양 | 1층",
  "이경준":"수리과학교육부 | 화학 | 2층",
  "김정현":"수리과학교육부 | 물리 | 2층",
  "성홍연":"1학년부 | 부장 | 지구과학 | 1층",
  "최시황":"1학년부 | 1-1 | 지구과학 | 1층",
  "윤선희":"1학년부 | 1-2 | 도덕윤리 | 1층",
  "정하림":"1학년부 | 1-3 | 영어 | 1층",
  "박경진":"1학년부 | 1-4 | 역사 | 1층",
  "서경환":"1학년부 | 1-5 | 일반사회 | 1층",
  "고한솔":"1학년부 | 1-6 | 영어 | 1층",
  "김지현":"1학년부 | 1-7 | 역사 | 1층",
  "진현충":"1학년부 | 1-8 | 음악 | 1층",
  "김영현":"1학년부 | 1-9 | 영어 | 1층",
  "박찬해":"1학년부 | 1-10 | 국어 | 1층",
  "이경진":"1학년부 | 1-11 | 수학 | 1층",
  "정홍명":"2학년부 | 부장 | 수학 | 4층",
  "이재철":"2학년부 | 2-1 | 영어 | 4층",
  "현지아":"2학년부 | 2-2 | 역사 | 4층",
  "방민영":"2학년부 | 2-3 | 일반사회 | 4층",
  "김정민":"2학년부 | 2-4 | 음악 | 4층",
  "윤효정":"2학년부 | 2-5 | 일본어 | 4층",
  "이용순":"2학년부 | 2-6 | 중국어 | 4층",
  "이소민":"2학년부 | 2-7 | 물리 | 4층",
  "김은지":"2학년부 | 2-8 | 영어 | 4층",
  "박미홍":"2학년부 | 2-9 | 생명과학 | 4층",
  "최수민":"2학년부 | 2-10 | 국어 | 4층",
  "류민수":"2학년부 | 2-11 | 체육 | 4층",
  "홍지현":"3학년부 | 부장 | 일반사회 | 5층",
  "한우리":"3학년부 | 3-1 | 미술 | 5층",
  "박정원":"3학년부 | 3-2 | 일반사회 | 5층",
  "한혜중":"3학년부 | 3-3 | 국어 | 5층",
  "김현진":"3학년부 | 3-4 | 수학 | 5층",
  "최원태":"3학년부 | 3-5 | 도덕윤리 | 5층",
  "최진철":"3학년부 | 3-6 | 한문 | 5층",
  "조현선":"3학년부 | 3-7 | 영어 | 5층",
  "강지원":"3학년부 | 3-8 | 영어 | 5층",
  "이솔희":"3학년부 | 3-9 | 가정 | 5층",
  "이미령":"3학년부 | 3-10 | 수학 | 5층",
  "유지수":"3학년부 | 3-11 | 생명과학 | 5층",
  "송보미":"특수교육부 | 특수 | 2층",
  "김미정":"특수교육부 | 특수 | 2층",
  "김나연":"특수교육부 | 특수 | 2층",
  "박지원":"특수교육부 | 특수 | 2층",
  "류은희":"특수교육부 | 특수 | 2층"
};

// 과목명 → 담당 교사 매핑
const subjectTeacherMap = {
  "화법과 작문": ["한혜중", "한선희"],
  "언어와 매체": ["한선희"],
  "문학": ["최수민", "정경", "이일영"],
  "고전 읽기": ["김소라", "정경"],
  "수학": ["신은경", "서유태", "정홍명"],
  "미적분": ["이미령"],
  "확률과 통계": ["최민경", "김현진", "이미령"],
  "기하": ["최민경", "서유태"],
  "경제 수학": ["백승옥"],
  "영어 회화": ["조현선", "강지원"],
  "영어": ["한가연", "정하림", "이재철", "김은지"],
  "영어 독해와 작문": ["조현선", "한가연", "강지원"],
  "진로 영어": ["조현선", "강지원"],
  "한국지리": ["이의남"],
  "세계지리": ["조일환"],
  "세계사": ["현지아"],
  "경제": ["홍지현"],
  "정치와 법": ["방민영"],
  "사회문화": ["방민영", "박정원"],
  "생활과 윤리": ["윤선희", "최원태"],
  "윤리와 사상": ["유주연"],
  "여행지리": ["이의남"],
  "사회문제 탐구": ["조일환", "손기민", "박정원", "서경환"],
  "고전과 윤리": ["유주연", "최원태"],
  "사회 탐구 방법": ["박정원"],
  "물리학1": ["이소민"],
  "물리학2": ["김정현"],
  "화학1": ["유민지"],
  "화학2": ["이경준"],
  "생명과학1": ["박미홍"],
  "생명과학2": ["유지수"],
  "지구과학1": ["최시황"],
  "지구과학2": ["성홍연"],
  "생활과 과학": ["김정현", "유민지", "유지수"],
  "융합과학": ["이경준"],
  "운동과 건강": ["장탁홍", "류민수", "서현군"],
  "스포츠 생활": ["김혁", "서현군"],
  "체육 전공 실기 기초": ["박종배"],
  "음악 연주": ["김정민"],
  "음악 감상과 비평": ["김정민", "진현충"],
  "미술 창작": ["한우리"],
  "미술 감상과 비평": ["장용남", "한우리"],
  "정보": ["김근원", "오세정"],
  "공학 일반": ["이봉희"],
  "일본어": ["권순아", "윤효정"],
  "중국어": ["이용순"],
  "한문": ["최진철"],
  "교육학": ["최진철"],
  "실용 경제": ["홍지현"],
  "중국어 회화": ["이용순"],
  "일본어 회화": ["권순아", "윤효정"],
  "식품과 영양": ["이솔희"],
  "인공지능 기초": ["장선희", "김근원"],
  "생활과 한문": ["최진철"],
  "공통국어": ["김소라", "박찬해", "이미숙"],
  "공통수학": ["최명주", "이경진", "백승옥"],
  "공통영어": ["고한솔", "정하림", "김영현"],
  "한국사": ["박경진", "김지현", "현지아"],
  "통합사회": ["손기민", "서경환", "윤선희"],
  "통합과학": ["박미홍", "성홍연", "김정현", "이소민", "최시황"],
  "과학탐구실험": ["박미홍", "성홍연", "김정현", "이소민", "최시황"],
  "체육": ["장탁홍", "박종배", "류민수"],
  "음악": ["진현충"],
  "미술": ["장용남"],
  "기술": ["이봉희"],
  "물리학": ["김정현", "이소민"],
  "가정": ["이솔희"],
  "화학": ["이경준", "유민지"]
};

// ✉️ 챗 엔드포인트
app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message.trim();

  // 1. 교사 이름이 포함되어 있는지 검사
  for (const teacher of Object.keys(teacherLocationMap)) {
    if (userMessage.includes(teacher)) {
      const location = teacherLocationMap[teacher];
      return res.json({ reply: `${teacher} 선생님의 교무실 위치는 ${location}입니다.` });
    }
  }

  // 2. 과목명이 포함되어 있는지 검사
  for (const subject of Object.keys(subjectTeacherMap)) {
    if (userMessage.includes(subject)) {
      const teachers = subjectTeacherMap[subject].join(", ");
      return res.json({ reply: `“${subject}” 과목의 담당 선생님은 ${teachers} 선생님입니다.` });
    }
  }

  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [{ role: "user", content: userMessage }],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        },
      }
    );

    const reply = response.data.choices[0].message.content;

    // ✅ 콘솔에 이용 기록 로그 출력
    console.log("🗨️ 이용 기록 ==================");
    console.log("📅 시간:", new Date().toLocaleString());
    console.log("🙋 사용자:", userMessage);
    console.log("🤖 챗봇 응답:", reply);
    console.log("================================\n");

    res.json({ reply });
  } catch (error) {
    console.error("❌ GPT 호출 오류:", error.response?.data || error.message);
    res.status(500).json({ error: "GPT 응답 실패" });
  }
});

app.listen(PORT, () => {
  console.log(`✅ 서버 실행 중: http://localhost:${PORT}`);
});
