require("dotenv").config();
const express = require("express");
const axios = require("axios");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static("public"));

// ðŸ§  ì„ ìƒë‹˜ ì´ë¦„ê³¼ êµë¬´ì‹¤ ìœ„ì¹˜ ë°ì´
const teacherLocations = {
  "ë°±ìŠ¹ì˜¥": "í•™ìƒì•ˆì „ì¸ê¶Œë¶€(4ì¸µ)",
  "ê¹€ì†Œë¼": "í•™ìƒì•ˆì „ì¸ê¶Œë¶€(4ì¸µ)",
  "ì´ë´‰í¬": "êµìœ¡ì—°êµ¬ë¶€(2ì¸µ)",
  "ìµœì§„ì² ": "3í•™ë…„ë¶€(5ì¸µ)",
  "ê¹€ì •í˜„": "ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€(2ì¸µ)",
  "ìž¥ìš©ë‚¨": "ì§„ë¡œìƒë‹´ë¶€(4ì¸µ)",
  "í•œìš°ë¦¬": "3í•™ë…„ë¶€(5ì¸µ)",
  "ì´ë¯¸ë ¹": "3í•™ë…„ë¶€(5ì¸µ)",
  "ë°•ì •ì›": "3í•™ë…„ë¶€(5ì¸µ)",
  "ë°©ë¯¼ì˜": "2í•™ë…„ë¶€(4ì¸µ)",
  "ì„œê²½í™˜": "1í•™ë…„ë¶€(1ì¸µ)",
  "ì¡°ì¼í™˜": "êµìœ¡ì—°êµ¬ë¶€(2ì¸µ)",
  "ìœ ì§€ìˆ˜": "3í•™ë…„ë¶€(5ì¸µ)",
  "ìœ¤ì„ í¬": "1í•™ë…„ë¶€(1ì¸µ)",
  "ìµœì›íƒœ": "3í•™ë…„ë¶€(5ì¸µ)",
  "ê¹€í˜": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€(3ì¸µ)",
  "ì„œí˜„êµ°": "í•™ìƒì•ˆì „ì¸ê¶Œë¶€(4ì¸µ)",
  "ì´ìŠ¬í¬": "3í•™ë…„ë¶€(5ì¸µ)",
  "í™ì§€í˜„": "3í•™ë…„ë¶€(5ì¸µ)",
  "í•œì„ í¬": "ê³ ë¬´ê¸°íšë¶€(2ì¸µ)",
  "ì´ì¸ì‚¼": "ë¯¸ëž˜êµìœ¡ë¶€(3ì¸µ)",
  "ê°•ì§€ì›": "3í•™ë…„ë¶€(5ì¸µ)",
  "í•œê°€ì—°": "ê³ ë¬´ê¸°íšë¶€(2ì¸µ)",
  "ì¡°í˜„ì„ ": "3í•™ë…„ë¶€(5ì¸µ)",
  "ì´ê²½ì¤€": "ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€(2ì¸µ)",
  "ì§„í˜„ì¤€": "1í•™ë…„ë¶€(1ì¸µ)",
  "ìž¥ì„ í¬": "ìˆ˜ì„êµì‚¬ì‹¤(3ì¸µ)",
  "ê¶Œìˆœì•„": "ê³ ë¬´ê¸°íšë¶€(2ì¸µ)",
  "ìœ¤íš¨ì •": "2í•™ë…„ë¶€(4ì¸µ)",
  "ì´ìš©ìˆœ": "2í•™ë…„ë¶€(4ì¸µ)",
  "ì„±ìš©ì—°": "1í•™ë…„ë¶€(1ì¸µ)",
  "ë°•ì¢…ë°°": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€(3ì¸µ)",
  "ì†ê¸°ë¯¼": "êµìœ¡ì—°êµ¬ë¶€(2ì¸µ)",
  "ìž¥íƒí™": "í•™ìƒì•ˆì „ì¸ê¶Œë¶€(4ì¸µ)",
  "í•œí˜œì¤‘": "3í•™ë…„ë¶€(5ì¸µ)",
  "ê¹€í˜„ì§„": "3í•™ë…„ë¶€(5ì¸µ)",
  "ìµœë¯¼ê²½": "ê³ ë¬´ê¸°íšë¶€(2ì¸µ)",
  "ìœ ë¯¼ì§€": "ê³ ë¬´ê¸°íšë¶€(2ì¸µ)",
};

app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message;

  // â‘  ì‚¬ìš©ìž ë©”ì‹œì§€ì—ì„œ ì„ ìƒë‹˜ ì´ë¦„ ì°¾ê¸°
  for (const [name, room] of Object.entries(teacherLocations)) {
    if (userMessage.includes(name)) {
      return res.json({ reply: `${name} ì„ ìƒë‹˜ì˜ êµë¬´ì‹¤ì€ ${room}ìž…ë‹ˆë‹¤.` });
    }
  }

  // â‘¡ GPTì—ê²Œ ì§ˆë¬¸ ë„˜ê¸°ê¸° (ì„ ìƒë‹˜ì´ ëª…ë‹¨ì— ì—†ì„ ê²½ìš°)
  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "ë„ˆëŠ” í•™êµ êµë¬´ì‹¤ ìœ„ì¹˜ë¥¼ ì•ˆë‚´í•˜ëŠ” ì±—ë´‡ì´ì•¼. ëª¨ë¥´ëŠ” ì •ë³´ëŠ” ì •ì¤‘í•˜ê²Œ ëª¨ë¥¸ë‹¤ê³  ëŒ€ë‹µí•´.",
          },
          {
            role: "user",
            content: userMessage,
          },
        ],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        },
      }
    );

    const reply = response.data.choices[0].message.content;
    res.json({ reply });
  } catch (error) {
    console.error("GPT í˜¸ì¶œ ì˜¤ë¥˜:", error.response?.data || error.message);
    res.status(500).json({ error: "GPT ì‘ë‹µ ì‹¤íŒ¨" });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
});
