require("dotenv").config();
const express = require("express");
const axios = require("axios");
const cors = require("cors");

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());
app.use(express.json());
app.use(express.static("public"));

// ðŸ§  ì„ ìƒë‹˜ ì´ë¦„ê³¼ êµë¬´ì‹¤ ìœ„ì¹˜ ë°ì´
const teacherLocations = {
  "ê¹€í˜„ì„": "êµìž¥ | êµìž¥ì‹¤ | 1ì¸µ",
  "ì˜¤ê²½ìˆœ": "êµê° | êµê°ì‹¤ | 2ì¸µ",
  "ìž¥ì„ í¬": "ìˆ˜ì„êµì‚¬ì‹¤ | ì •ë³´ì»´í“¨í„° | 3ì¸µ",
  "í•œì„ í¬": "êµë¬´ê¸°íšë¶€ | êµ­ì–´ | 2ì¸µ",
  "ê¶Œìˆœì•„": "êµë¬´ê¸°íšë¶€ | ì¼ë³¸ì–´ | 2ì¸µ",
  "ìœ ë¯¼ì§€": "êµë¬´ê¸°íšë¶€ | í™”í•™ | 2ì¸µ",
  "ìµœë¯¼ê²½": "êµë¬´ê¸°íšë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "í•œê°€ì—°": "êµë¬´ê¸°íšë¶€ | ì˜ì–´ | 2ì¸µ",
  "ì´ë´‰í¬": "êµìœ¡ì—°êµ¬ë¶€ | ê¸°ìˆ  | 2ì¸µ",
  "ì†ê¸°ë¯¼": "êµìœ¡ì—°êµ¬ë¶€ | ì§€ë¦¬ | 2ì¸µ",
  "ê¹€ê·¼ì›": "êµìœ¡ì—°êµ¬ë¶€ | ì •ë³´ì»´í“¨í„° | 2ì¸µ",
  "ì¡°ì¼í™˜": "êµìœ¡ì—°êµ¬ë¶€ | ì§€ë¦¬ | 2ì¸µ",
  "ìœ ì£¼ì—°": "ë¯¸ëž˜êµìœ¡ë¶€ | ë„ë•ìœ¤ë¦¬ | 3ì¸µ",
  "ì •ê²½": "ë¯¸ëž˜êµìœ¡ë¶€ | êµ­ì–´ | 3ì¸µ",
  "ì´ì˜ë‚¨": "ë¯¸ëž˜êµìœ¡ë¶€ | ì§€ë¦¬ | 3ì¸µ",
  "ì´ì¢…ë¯¸": "ë¯¸ëž˜êµìœ¡ë¶€ | ë„ì„œì‹¤ | ì‚¬ì„œ | 2ì¸µ",
  "ì„œìœ íƒœ": "êµìœ¡ê³¼ì •ë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "ì´ë¯¸ìˆ™": "êµìœ¡ê³¼ì •ë¶€ | êµ­ì–´ | 2ì¸µ",
  "ìµœëª…ì£¼": "êµìœ¡ê³¼ì •ë¶€ | ìˆ˜í•™ | 2ì¸µ",
  "ì„œí˜„êµ°": "í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ì²´ìœ¡ | 4ì¸µ",
  "ì´ì¼ì˜": "í•™ìƒìžì¹˜ì•ˆì „ë¶€ | êµ­ì–´ | 4ì¸µ",
  "ê¹€ì†Œë¼": "í•™ìƒìžì¹˜ì•ˆì „ë¶€ | êµ­ì–´ | 4ì¸µ",
  "ë°±ìŠ¹ì˜¥": "í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ìˆ˜í•™ | 4ì¸µ",
  "ìž¥íƒí™": "í•™ìƒìžì¹˜ì•ˆì „ë¶€ | ì²´ìœ¡ | 4ì¸µ",
  "ì—¼ì§€ì˜": "ì§„ë¡œìƒë‹´ë¶€ | ì§„ë¡œì „ë‹´ | 4ì¸µ",
  "ìž¥ìš©ë‚¨": "ì§„ë¡œìƒë‹´ë¶€ | ë¯¸ìˆ  | 4ì¸µ",
  "ì˜¤ì±„í˜„": "ì§„ë¡œìƒë‹´ë¶€ | ì „ë¬¸ìƒë‹´ | 4ì¸µ",
  "ì‹ ì€ê²½": "êµìœ¡ì •ë³´ë¶€ | ìˆ˜í•™ | 3ì¸µ",
  "ì˜¤ì„¸ì •": "êµìœ¡ì •ë³´ë¶€ | ì •ë³´ì»´í“¨í„° | 3ì¸µ",
  "ê¹€í˜": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ì²´ìœ¡ | 3ì¸µ",
  "ë°•ì¢…ë°°": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ì²´ìœ¡ | 3ì¸µ",
  "ê¹€íš¨ì˜": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ë³´ê±´ì‹¤ | ë³´ê±´ | 3ì¸µ",
  "ì „ì„ ì˜": "ë¬¸í™”ì˜ˆìˆ ì²´ìœ¡êµìœ¡ë¶€ | ê¸‰ì‹ì‹¤ | ì˜ì–‘ | 1ì¸µ",
  "ì´ê²½ì¤€": "ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€ | í™”í•™ | 2ì¸µ",
  "ê¹€ì •í˜„": "ìˆ˜ë¦¬ê³¼í•™êµìœ¡ë¶€ | ë¬¼ë¦¬ | 2ì¸µ",
  "ì„±í™ì—°": "1í•™ë…„ë¶€ | ë¶€ìž¥ | ì§€êµ¬ê³¼í•™ | 1ì¸µ",
  "ìµœì‹œí™©": "1í•™ë…„ë¶€ | 1-1 | ì§€êµ¬ê³¼í•™ | 1ì¸µ",
  "ìœ¤ì„ í¬": "1í•™ë…„ë¶€ | 1-2 | ë„ë•ìœ¤ë¦¬ | 1ì¸µ",
  "ì •í•˜ë¦¼": "1í•™ë…„ë¶€ | 1-3 | ì˜ì–´ | 1ì¸µ",
  "ë°•ê²½ì§„": "1í•™ë…„ë¶€ | 1-4 | ì—­ì‚¬ | 1ì¸µ",
  "ì„œê²½í™˜": "1í•™ë…„ë¶€ | 1-5 | ì¼ë°˜ì‚¬íšŒ | 1ì¸µ",
  "ê³ í•œì†”": "1í•™ë…„ë¶€ | 1-6 | ì˜ì–´ | 1ì¸µ",
  "ê¹€ì§€í˜„": "1í•™ë…„ë¶€ | 1-7 | ì—­ì‚¬ | 1ì¸µ",
  "ì§„í˜„ì¶©": "1í•™ë…„ë¶€ | 1-8 | ìŒì•… | 1ì¸µ",
  "ê¹€ì˜í˜„": "1í•™ë…„ë¶€ | 1-9 | ì˜ì–´ | 1ì¸µ",
  "ë°•ì°¬í•´": "1í•™ë…„ë¶€ | 1-10 | êµ­ì–´ | 1ì¸µ",
  "ì´ê²½ì§„": "1í•™ë…„ë¶€ | 1-11 | ìˆ˜í•™ | 1ì¸µ",
  "ì •í™ëª…": "2í•™ë…„ë¶€ | ë¶€ìž¥ | ìˆ˜í•™ | 4ì¸µ",
  "ì´ìž¬ì² ": "2í•™ë…„ë¶€ | 2-1 | ì˜ì–´ | 4ì¸µ",
  "í˜„ì§€ì•„": "2í•™ë…„ë¶€ | 2-2 | ì—­ì‚¬ | 4ì¸µ",
  "ë°©ë¯¼ì˜": "2í•™ë…„ë¶€ | 2-3 | ì¼ë°˜ì‚¬íšŒ | 4ì¸µ",
  "ê¹€ì •ë¯¼": "2í•™ë…„ë¶€ | 2-4 | ìŒì•… | 4ì¸µ",
  "ìœ¤íš¨ì •": "2í•™ë…„ë¶€ | 2-5 | ì¼ë³¸ì–´ | 4ì¸µ",
  "ì´ìš©ìˆœ": "2í•™ë…„ë¶€ | 2-6 | ì¤‘êµ­ì–´ | 4ì¸µ",
  "ì´ì†Œë¯¼": "2í•™ë…„ë¶€ | 2-7 | ë¬¼ë¦¬ | 4ì¸µ",
  "ê¹€ì€ì§€": "2í•™ë…„ë¶€ | 2-8 | ì˜ì–´ | 4ì¸µ",
  "ë°•ë¯¸í™": "2í•™ë…„ë¶€ | 2-9 | ìƒëª…ê³¼í•™ | 4ì¸µ",
  "ìµœìˆ˜ë¯¼": "2í•™ë…„ë¶€ | 2-10 | êµ­ì–´ | 4ì¸µ",
  "ë¥˜ë¯¼ìˆ˜": "2í•™ë…„ë¶€ | 2-11 | ì²´ìœ¡ | 4ì¸µ",
  "í™ì§€í˜„": "3í•™ë…„ë¶€ | ë¶€ìž¥ | ì¼ë°˜ì‚¬íšŒ | 5ì¸µ",
  "í•œìš°ë¦¬": "3í•™ë…„ë¶€ | 3-1 | ë¯¸ìˆ  | 5ì¸µ",
  "ë°•ì •ì›": "3í•™ë…„ë¶€ | 3-2 | ì¼ë°˜ì‚¬íšŒ | 5ì¸µ",
  "í•œí˜œì¤‘": "3í•™ë…„ë¶€ | 3-3 | êµ­ì–´ | 5ì¸µ",
  "ê¹€í˜„ì§„": "3í•™ë…„ë¶€ | 3-4 | ìˆ˜í•™ | 5ì¸µ",
  "ìµœì›íƒœ": "3í•™ë…„ë¶€ | 3-5 | ë„ë•ìœ¤ë¦¬ | 5ì¸µ",
  "ìµœì§„ì² ": "3í•™ë…„ë¶€ | 3-6 | í•œë¬¸ | 5ì¸µ",
  "ì¡°í˜„ì„ ": "3í•™ë…„ë¶€ | 3-7 | ì˜ì–´ | 5ì¸µ",
  "ê°•ì§€ì›": "3í•™ë…„ë¶€ | 3-8 | ì˜ì–´ | 5ì¸µ",
  "ì´ì†”í¬": "3í•™ë…„ë¶€ | 3-9 | ê°€ì • | 5ì¸µ",
  "ì´ë¯¸ë ¹": "3í•™ë…„ë¶€ | 3-10 | ìˆ˜í•™ | 5ì¸µ",
  "ìœ ì§€ìˆ˜": "3í•™ë…„ë¶€ | 3-11 | ìƒëª…ê³¼í•™ | 5ì¸µ",
  "ì†¡ë³´ë¯¸": "íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ê¹€ë¯¸ì •": "íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ê¹€ë‚˜ì—°": "íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ë°•ì§€ì›": "íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ",
  "ë¥˜ì€í¬": "íŠ¹ìˆ˜êµìœ¡ë¶€ | íŠ¹ìˆ˜ | 2ì¸µ"
};

app.post("/api/chat", async (req, res) => {
  const userMessage = req.body.message;

  // â‘  ì‚¬ìš©ìž ë©”ì‹œì§€ì—ì„œ ì„ ìƒë‹˜ ì´ë¦„ ì°¾ê¸°
  for (const [name, room] of Object.entries(teacherLocations)) {
    if (userMessage.includes(name)) {
      return res.json({ reply: `${name} ì„ ìƒë‹˜ì˜ êµë¬´ì‹¤ì€ ${room}ìž…ë‹ˆë‹¤.` });
    }
  }

  // â‘¡ GPTì—ê²Œ ì§ˆë¬¸ ë„˜ê¸°ê¸° (ì„ ìƒë‹˜ì´ ëª…ë‹¨ì— ì—†ì„ ê²½ìš°)
  try {
    const response = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "ë„ˆëŠ” í•™êµ êµë¬´ì‹¤ ìœ„ì¹˜ë¥¼ ì•ˆë‚´í•˜ëŠ” ì±—ë´‡ì´ì•¼. ëª¨ë¥´ëŠ” ì •ë³´ëŠ” ì •ì¤‘í•˜ê²Œ ëª¨ë¥¸ë‹¤ê³  ëŒ€ë‹µí•´.",
          },
          {
            role: "user",
            content: userMessage,
          },
        ],
      },
      {
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        },
      }
    );

    const reply = response.data.choices[0].message.content;
    res.json({ reply });
  } catch (error) {
    console.error("GPT í˜¸ì¶œ ì˜¤ë¥˜:", error.response?.data || error.message);
    res.status(500).json({ error: "GPT ì‘ë‹µ ì‹¤íŒ¨" });
  }
});

app.listen(PORT, () => {
  console.log(`âœ… ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
});
